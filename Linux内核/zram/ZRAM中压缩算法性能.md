
本文测试均在SM8735平台下进行。

## 静态测试

**在recovery模式下测试-开启cpu performance**
压缩性能与压缩数据有关！该数据仅供参考！

测试前需对 ZRAM 设备进行初始化配置，具体命令如下：

```bash
ashell '\
swapoff /dev/block/zram0; \
echo 1 > /sys/class/block/zram0/reset; \
echo lz4 > /sys/class/block/zram0/comp_algorithm; \
echo 8 > /sys/class/block/zram0/max_comp_streams; \
echo 8G > /sys/class/block/zram0/disksize;\
'
```

该配置将 ZRAM 设备设置为 8GB 大小，采用 lz4 压缩算法，并启用 8 个压缩流。

### 数据量大&有缓存

测试命令
```bash
fio -filename=/dev/block/zram0 -thread -rw=write -bs=1M -size=4096M -group_reporting -numjobs=8 -name=mytest
```

|       | 单线程   |       |            | 8线程    |       |            |
| ----- | ----- | ----- | ---------- | ------ | ----- | ---------- |
| MiB/s | lz4   | zstd  | 混合30%-zstd | lz4    | zstd  | 混合30%-zstd |
| 1     | 785   | 157   | 364        | 5883   | 417   | 1157       |
| 2     | 783   | 154   | 352        | 2693   | 407   | 873        |
| 3     | 768   | 115   | 345        | 5447   | 445   | 1170       |
| 4     | 765   | 127   | 352        | 1752   | 445   | 987        |
| 5     | 762   | 119   | 343        | 1929   | 429   | 862        |
| avg   | 772.6 | 134.4 | 351.2      | 3540.8 | 428.6 | 1009.8     |

### 数据量小&无缓存

测试命令
```bash
fio -filename=/dev/block/zram0 -thread -rw=write -bs=1M -size=512M -group_reporting -numjobs=8 -name=mytest -direct=1
```

|       | 单线程    |       |              | 8线程    |       |              |
| ----- | ------ | ----- | ------------ | ------ | ----- | ------------ |
| MiB/s | lz4    | zstd  | 动态（30%-zstd) | lz4    | zstd  | 动态（30%-zstd) |
| 1     | 800    | 143   | 337          | 3003   | 647   | 1458         |
| 2     | 801    | 141   | 349          | 2940   | 616   | 1435         |
| 3     | 804    | 141   | 332          | 2889   | 434   | 1403         |
| 4     | 824    | 141   | 332          | 2934   | 206   | 1390         |
| 5     | 798    | 141   | 332          | 2926   | 186   | 1107         |
| avg   | 807.25 | 141.4 | 336.4        | 2938.4 | 417.8 | 1358.6       |

### 数据量少&带缓存（无实际意义）

测试命令
```bash
fio -filename=/dev/block/zram0 -thread -rw=write -bs=1M -size=512M -group_reporting -numjobs=8 -name=mytest
```

|       | 单线程  |        |            | 8线程    |      |            |
| ----- | ---- | ------ | ---------- | ------ | ---- | ---------- |
| MiB/s | lz4  | zstd   | 混合30%-zstd | lz4    | zstd | 混合30%-zstd |
| 1     | 4830 | 4830   | 4697       | 3890   | 532  | 1222       |
| 2     | 4785 | 4785   | 4697       | 2722   | 510  | 1104       |
| 3     | 4830 | 4876   | 4741       | 3977   | 528  | 1011       |
| 4     | 4785 | 4785   | 4697       | 2246   | 855  | 1120       |
| 5     | 4830 | 4830   | 4741       | 2481   | 515  | 1134       |
| avg   | 4812 | 4821.2 | 4714.6     | 3063.2 | 588  | 1118.2     |

### 小结

fio的数据源似乎是完全的随机数据，故在检查压缩率时显示读入数据大小与使用大小完全一致。
**压缩速度和压缩率会受输入数据类型的显著影响**，核心原因在于不同数据的内容特性（如重复模式、规律性）差异。

| 数据类型      | 压缩速度（相对） | 压缩率         |
| --------- | -------- | ----------- |
| 日志文件（文本）  | 快        | 3:1~5:1     |
| 源代码（C 语言） | 中        | 2:1~3:1     |
| 视频文件（MP4） | 快        | 1.2:1~1.5:1 |
| 随机二进制数据   | 慢        | 1.1:1 以下    |

由于fio测试是使用随机数据，与实际的内存数据差异较大。**故该页数据仅供参考，不能视为实际使用场景性能**。

另外可能有同学看过这篇帖子[zram lz4 和 lzo 算法性能评估比较](https://blog.csdn.net/qkhhyga2016/article/details/78927314)，可能会疑惑为何上文测试的性能会这么低？其实仔细看帖子中的测试命令可以知道，其全程测试都没有加`-direct=1`配置，故在fio测试时数据会优先保存在文件系统缓存中，导致这样的测试数据**没有参考意义**。并且我们可以通过[lz4](https://github.com/lz4/lz4)了解到，各类算法在i7-9700K中的测试数据对比，与帖子中差距明显。
如果有条件的话建议使用[better_benchmarks.bash](https://pastebin.com/raw/zmpPEsHh)进行测试，本文就不再重复了。因为zram的使用场景，即app的实际内存数据使用fio是无法模拟的，下文会有更好的方法进行测试。

## 动态测试

关wifi，同一机器。
测试前关温控、打开cpu performance、复位zram和swap。接着跑 app 连续启动，并统计检查相关数据。

| lz4         |              |             |         |             |             |        |            |             |              |
| ----------- | ------------ | ----------- | ------- | ----------- | ----------- | ------ | ---------- | ----------- | ------------ |
| 读入大小 (byte) | 压缩后大小 (byte) | 压缩率(n:1)    | 读取页数    | 总耗时(ns)     | compress    | 读取页数   | 总耗时(ns)    | decompress  | app启动总耗时 (秒) |
| 3567484928  | 1243013120   | 2.87        | 1630672 | 27239855358 | 233.842     | 121304 | 1081565431 | 438.109     | 167.784685   |
| 2993516544  | 987078656    | 3.03        | 1154570 | 19325174242 | 233.376     | 85171  | 762516854  | 436.317     | 175.072857   |
| 2598989824  | 857280512    | 3.03        | 1021601 | 16777802351 | 237.852     | 88396  | 850489691  | 405.998     | 173.725026   |
| 3206578176  | 1062141952   | 3.02        | 1223527 | 18003638963 | 265.469     | 77310  | 682280203  | 442.622     | 167.27369    |
| 3433889792  | 1144176640   | 3.00        | 1084878 | 16926002074 | 250.372     | 91183  | 826952343  | 430.718     | 168.869244   |
| 3160091853  | 1058738176   | 2.990912569 |         |             | 244.1821717 |        |            | 430.75289   | 170.5451004  |
| lz4k        |              |             |         |             |             |        |            |             |              |
| 读入大小 (byte) | 压缩后大小 (byte) | 压缩率(n:1)    | 读取页数    | 总耗时(ns)     | compress    | 读取页数   | 总耗时(ns)    | decompress  | app启动总耗时 (秒) |
| 3246161920  | 1001246720   | 3.24        | 1284535 | 16619555013 | 301.916     | 166217 | 1324255230 | 490.302     | 185.345321   |
| 3163697152  | 1024000000   | 3.09        | 1507215 | 20495344992 | 287.263     | 100372 | 838693716  | 467.487     | 164.021935   |
| 3352420352  | 1101672448   | 3.04        | 1408203 | 18335221683 | 300.012     | 89987  | 760940055  | 461.944     | 169.828563   |
| 3572031488  | 1186607104   | 3.01        | 1389327 | 17816489095 | 304.609     | 108565 | 904378023  | 468.921     | 169.782205   |
| 3142508544  | 1046654976   | 3.00        | 1406166 | 19369718674 | 283.579     | 85522  | 756962190  | 441.330     | 166.318727   |
| 3295363891  | 1072036250   | 3.07748327  |         |             | 295.4758288 |        |            | 465.9968552 | 171.0593502  |
| lz4kd       |              |             |         |             |             |        |            |             |              |
| 读入大小 (byte) | 压缩后大小 (byte) | 压缩率(n:1)    | 读取页数    | 总耗时(ns)     | compress    | 读取页数   | 总耗时(ns)    | decompress  | app启动总耗时 (秒) |
| 3134623744  | 992366592    | 3.16        | 1481939 | 20471609390 | 282.773     | 92807  | 790615138  | 458.538     | 174.893571   |
| 3433742336  | 1086668800   | 3.16        | 1379587 | 18436657034 | 292.299     | 79273  | 610968250  | 506.835     | 163.261626   |
| 3320868864  | 1014591488   | 3.27        | 1414281 | 18055534550 | 305.975     | 128131 | 972882639  | 514.463     | 178.506504   |
| 2558291968  | 835629056    | 3.06        | 1207940 | 15056490551 | 313.387     | 73788  | 553302470  | 520.935     | 158.3499     |
| 3343392768  | 1069375488   | 3.13        | 1573945 | 20804336962 | 295.526     | 78858  | 635157541  | 484.981     | 160.160585   |
| 3158183936  | 999726284.8  | 3.155946319 |         |             | 297.9920256 |        |            | 497.1502271 | 167.0344372  |
| lz4k_oplus  |              |             |         |             |             |        |            |             |              |
| 读入大小 (byte) | 压缩后大小 (byte) | 压缩率(n:1)    | 读取页数    | 总耗时(ns)     | compress    | 读取页数   | 总耗时(ns)    | decompress  | app启动总耗时 (秒) |
| 2422804480  | 768249856    | 3.15        | 1252801 | 15848406295 | 308.785     | 64760  | 530928432  | 476.465     | 165.833124   |
| 2465800192  | 773873664    | 3.19        | 1396802 | 19172782900 | 284.584     | 83278  | 695576121  | 467.677     | 164.646587   |
| 2596995072  | 821833728    | 3.16        | 1144088 | 14869094170 | 300.563     | 82605  | 682144687  | 473.031     | 168.896333   |
| 3593781248  | 1134374912   | 3.17        | 1480452 | 19231503273 | 300.705     | 87254  | 699955508  | 486.939     | 172.3804     |
| 2818207744  | 908107776    | 3.10        | 1276710 | 16498974175 | 302.270     | 70347  | 572985131  | 479.581     | 166.305832   |
| 2779517747  | 881287987.2  | 3.154286583 |         |             | 299.3813806 |        |            | 476.7387084 | 167.6124552  |

（其中compress和decompress的数据是使用kprobe抓取了compress/decompress的次数和时间，zram中每次压缩一页，这样计算的压缩率。）
其实从实际表现来看，传统zram中的lz4和zstd算法在app连续启动测试中对启动耗时影响并不大。
主要的差异在于压缩率，lz4为32.7%，zstd为21.2%。
两者压缩率差约10%。也就是说在完全吃满8G的情况下可以节约819MB。但是平均压缩速度要降低172MB/s，降幅达到63%左右，可以得知这种转换不值得。
若使用动态切换算法，其压缩率、速度等性能无非只是在lz4-zstd之间调节。
基于上述结论，动态切换zram算法的设计在目前似乎并不高效，除非可以提高zstd压缩速度。

### 小结

|       | 压缩率         | 压缩速度        |
| ----- | ----------- | ----------- |
| lz4   | 2.990912569 | 244.1821717 |
| lz4k  | 3.07748327  | 295.4758288 |
| lz4kd | 3.155946319 | 297.9920256 |
| zstd  | 4.71        | 100.5896447 |

由上面统计的各类压缩算法在m2582上的性能数据图示如下。
图示中越靠近右上角表示综合性能越强。

![[mk.att/压缩率，压缩速度.png]]

## 测试用命令

```bash
close_thermal_engine() {
    ashell stop thermal-engine
    ashell setprop ctl.stop thermal-engine
}

cpu_performance() {
    ashell '\
        # 获取 CPU 核心的数量
        n=$(nproc)
        # 对每个 CPU 核心进行设置
        for i in $(seq 0 $((n-1))); do
            echo performance | tee /sys/devices/system/cpu/cpu$i/cpufreq/scaling_governor
        done \
        '
}

test_pre() {
    ashell '\
    echo !zcomp_compress > /proc/simple_trace/ctrl; \
    echo !zcomp_decompress > /proc/simple_trace/ctrl; \
    echo ?zcomp_compress > /proc/simple_trace/ctrl; \
    echo ?zcomp_decompress > /proc/simple_trace/ctrl; \
    '

    ashell '\
    swapoff /dev/block/zram0; \
    echo 1 > /sys/class/block/zram0/reset; \
    echo lz4 > /sys/class/block/zram0/comp_algorithm; \
    echo 8 > /sys/class/block/zram0/max_comp_streams; \
    echo 8G > /sys/class/block/zram0/disksize;\
    '
    ashell '\
    mkswap /dev/block/zram0; \
    swapon /dev/block/zram0; \
    '
}

ashell 'cat /sys/block/zram0/comp_algorithm /sys/block/zram0/mm_stat ; free -h; cat /proc/simple_trace/info'

```

## 参考链接

- https://github.com/lz4/lz4
- https://github.com/YuzakiKokuban/android_kernel_samsung_sm8750/commit/64e42fbe268932c6559bac5d4f98870cada23857
- https://github.com/zelodev/kernel_xiaomi_sm6150/commit/8aaa73da06b09b43eca30da6eaf68d9f7bebe1ea
- https://www.pling.com/p/2157520
- https://blog.csdn.net/qkhhyga2016/article/details/78927314
